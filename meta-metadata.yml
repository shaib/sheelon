preamble:
  title: ניתוח שאלון שלומות
  description_html: |-
    <p>הצגה של נתונים מתוך שאלון שלמות, עם אפשרות לחיתוכים.</p>
    <ul>
      <li>זוהי גרסה ראשונית בלבד</li>
    </ul>
  databases:
    sheelon:
      tables:
        sheelon:
          allow: false

  allow:
    id:
      - superuser
      - root

  plugins:
    datasette-auth-passwords:
      superuser_password_hash:
        $env: PASSWORD_HASH_SUPER_1

dashboard:
  name: shlomut
  static:
    title: שאלון שלומות
    description: שאלון עם דמוגרפיה
    filters:
      a_gender:
        name: מגדר
        type: select
        options: [גבר, אישה, מעדיף/ה לא לציין]
      b_gen_expr_low:
        name: מינ ותק בחינוך
        type: number
        min: 0
        max: 100
        step: 1
      c_gen_expr_high:
        name: מקס ותק בחינוך
        type: number
        min: 0
        max: 100
        step: 1
      d_local_expr_low:
        name: מינ ותק בחינוך במ״א אשכול
        type: number
        min: 0
        max: 100
        step: 1
      e_local_expr_high:
        name: מקס ותק בחינוך במ״א אשכול
        type: number
        min: 0
        max: 100
        step: 1
      f_position:
        name: תפקיד
        type: select
        options:
          - יועץ/ת
          - מורה מקצוע
          - מורה/ת שילוב
          - מחנכ/ת
          - מתנדב/ת
          - סייע/ת גיל הרך
          - סייע/ת חינוך מיוחד
          - תומך/ת הוראה
      g_school:
        name: בית ספר
        type: select
        options:
          - מרחבי אשכול
          - נופי הבשור
          - נעם נצרים בנות
          - נעם נצרים בנים
          - קידום הנוער
          - שדות אשכול
          - שחר אשכול
    charts:
      t1:
        library: markdown
        display: |-
          # שאלון שלומות
          > תיכף נראה מה זה זה
    layout:
      - [t1, '.']
          
  generate:
    query:
      preamble: WITH
        filtered AS (
          SELECT * FROM sheelon WHERE TRUE
            [[ AND "מגדר" = :a_gender ]]
            [[ AND "שנות ותק בחינוך/בהוראה" >= :b_gen_expr_low ]]
            [[ AND "שנות ותק בחינוך/בהוראה" <= :c_gen_expr_high ]]
            [[ AND "שנות וותק במערכת החינוך במועצה איזורית אשכול" >= :d_local_expr_low ]]
            [[ AND "שנות וותק במערכת החינוך במועצה איזורית אשכול" <= :e_local_expr_high ]]
            [[ AND "תפקידך במערכת החינוך:" = :f_position ]]
            [[ AND "שם בית הספר" = :g_school ]]
          ),
        t AS (SELECT COUNT(*) AS total_count FROM filtered),
        data AS (
          SELECT filtered.* FROM filtered CROSS JOIN t WHERE total_count>5
        )
      count_template:
        SELECT {field_name} AS what, COUNT({field_name}) AS num
        FROM data
        WHERE LENGTH(what)>1
        GROUP BY what
      option_set_clause_template:
        SELECT '{field_name}' AS what, SUM("{set_name}÷{field_name}") AS num
        FROM data

    level_choice:
      static:
        db: sheelon
        library: vega-lite
        # insert title
        # insert query
        display:
          mark: { type: bar, tooltip: true }
          transform:
            - impute: num
              key: what
              # keyvals to be inserted here
              method: value
              value: 0
            - # 'calculate' to be inserted here
              as: sorter
            - calculate: "'‏' + datum.sorter"  # Note: the '' contains a RLM
              as: sorterrtl
              
          encoding:
            x:
              field: num
              type: quantitative
              title: 'מספר'
              scale: {"domain": [0,240]}
            color:
              field: sorterrtl
              type: nominal
              # title to be inserted here
              legend:
                direction: horizontal
                orient: top

      keyvals:
        מידה:
          - "במידה מועטה מאוד או כלל לא"
          - "במידה מועטה"
          - "במידה בינונית"
          - "במידה רבה"
          - "במידה רבה מאוד"
        תדירות:
          - "בתדירות מועטה מאוד או כלל לא"
          - "בתדירות מועטה"
          - "בתדירות בינונית"
          - "בתדירות רבה"
          - "בתדירות רבה מאוד"
        איכות:
          - א. מצוינת
          - ב. טובה מאוד
          - ג. טובה
          - ד. סבירה
          - ה. לא טובה
        איכות גם:
          - א. מצוין
          - ב. טוב
          - ג. בינוני
          - ד. לא טוב
          - ה. כלל לא טוב

    option_set:
      static:
        db: sheelon
        library: vega-lite
        # insert title
        # insert query
        display:
          mark: { type: bar, tooltip: true }
          transform:
            - calculate: "replace(datum.what,
              'אחר (נא',
              '‏אחר (נא'
              )"
              # The replacement has a RLM, to make values that
              # start with this string last in order
              as: sorter
          encoding:
            y:
              field: num
              scale:
                domain:
                  - 0
                  - 100
              title: 'מספר'
              type: quantitative
            x:
              field: sorter
              type: nominal
              # title to be inserted here
            color:
              field: sorter
              type: nominal
              # title to be inserted here
              legend:
                direction: vertical
                orient: top
                # labelAlign: right
                labelLimit: 320
